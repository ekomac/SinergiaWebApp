{% extends 'base_system.html' %} {% block content %} {% load places_extras %}

{% load price_extras %}

<div class="col-md-12 col-lg-8 col-xl-6 col-xxl-5 d-flex-block">
    <form method='POST' id="create_form" class="card flex-fill shadow-lg bg-white" name="create_form" target="_top"
        enctype="multipart/form-data">{% csrf_token %}
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                Crear objeto
            </div>
            <div>
                <a href="{{ request.META.HTTP_REFERER }}"><i class="bi bi-arrow-left-short"></i>Volver</a>
            </div>
        </div>
        <div class="card-body">
            <h3 class="card-title text-center mt-3">CREAR ZONA AMBA</h3>
            <h4 class="card-title mt-3">Datos de la zona amba</h4>
            <div class="row g-3">


                <!-- START NAME INPUT -->
                <div class="col-md-12 col-lg-8">
                    <label for="id_name" class="form-label">Nombre</label>
                    <input id="id_name" name="name" type="text" {% if form.name.value %}value="{{form.name.value}}"
                        {% endif %} class="form-control {% if form.name.errors %}is-invalid{% endif %}"
                        placeholder="Nombre" required>
                    <div class="invalid-feedback">
                        {% for error in form.name.errors %}{{error}}<br>{% endfor %}
                    </div>

                </div>
                <!-- END NAME INPUT -->


                <!-- START ASIGNED TO INPUT -->
                <div class="col-md-12 col-lg-8">
                    <label for="{{form.asigned_to.id_for_label}}" class="form-label">Distribuidor de la zona</label>
                    {{ form.asigned_to}}
                </div>
                <!-- END ASIGNED TO INPUT -->


                <!-- START PARTIDOS CONTAINER -->
                <div class="col-12">
                    <label for="partidosContainer" class="form-label">Partidos en esta zona</label>
                    <div id="partidosContainer" class="border border-1 rounded border-dark p-2">
                        <span id="nonePartidoSpan" class="m-2">Ning√∫n partido</span>
                    </div>
                </div>
                <!-- END PARTIDOS CONTAINER -->

                <!-- START PARTIDOS CONTAINER -->
                <div class="d-none">
                    <input type="text" id="id_selected_partidos_ids" name="selected_partidos_ids"
                        value="{% if partidos_ids %}{{partidos_ids}}{% endif %}">
                </div>
                <!-- END PARTIDOS CONTAINER -->


                <!-- START PARTIDOS SELECT -->
                <div class="col-12">
                    <div class="input-group">
                        <select class="form-select" id="selectPartido" aria-label="Example select with button addon">
                            {% if partidos %}
                            {% for partido in partidos %}
                            <option id="option-{{ partido.id }}" class="sortMe" value="{{ partido.id }}">
                                {{ partido.name |title}}{% if partido.amba_zone %}&nbsp;(en
                                zona&nbsp;{{partido.amba_zone.name}}){% endif %}
                            </option>
                            {% endfor %}
                            {% endif %}
                        </select>
                        <button class="btn btn-outline-secondary" id="addPartidoBtn" type="button"
                            onclick='addPartido()'>Agregar a la zona</button>
                    </div>
                </div>
                <!-- END PARTIDOS SELECT -->



                <!-- START SUMBIT BUTTON -->
                <div class="d-grid gap-2 d-md-flex">
                    <input type="submit" value="Crear zona" class="btn btn-primary">
                </div>
                <!-- END SUMBIT BUTTON -->

            </div>
        </div>
    </form>

</div>

<script>
    var partidosTotal = JSON.parse('{{ partidosTotal |escapejs}}');

    $(document).ready(function () {

        var selectedPartidosIds = document.getElementById('id_selected_partidos_ids').value;
        console.log(selectedPartidosIds);
        if (selectedPartidosIds != '') {
            bulkAddPartido(selectedPartidosIds);
        }

        $('#create_form').submit(function (event) {
            event.preventDefault(); //this will prevent the default submit
            updateIds();
            $(this).unbind('submit').submit(); // continue the submit unbind preventDefault
        });
        sortSelectOptions('selectPartido');
        selectFirst();
    });

    function updateIds() {
        document.getElementById('id_selected_partidos_ids').value = getSelectedPartidosIds();
    }

    function selectFirst() {
        try {
            document.getElementById('selectPartido').selectedIndex = 0;
        } catch (e) {
            console.log("selectPartido didn't have any elements.")
        }
    }

    function bulkAddPartido(presetIds) {
        var ids = presetIds.split("-");
        var selectPartido = document.getElementById('selectPartido');
        var options = Array.from(selectPartido.options);

        for (var i = options.length - 1; i >= 0; i--) {
            var option = options[i];
            var selectedId = option.value;
            if (ids.includes(selectedId)) {
                var selectedText = option.text;
                appendButton(selectedId, selectedText);
                selectPartido.remove(i);
            }
        }
        selectFirst();
    }

    function addPartido() {
        var selectPartido = document.getElementById('selectPartido');
        var selectedIndex = selectPartido.selectedIndex;
        var htmlOptions = selectPartido.options;

        var selectedId = htmlOptions[selectedIndex].value;
        var selectedText = htmlOptions[selectedIndex].text;

        selectPartido.remove(selectedIndex);
        appendButton(selectedId, selectedText);
    }

    function appendButton(id, text) {
        $('#nonePartidoSpan').hide();
        var cleanedText = text.includes("(en") ? text.split("(en")[0].trim() : text.trim();
        var button = document.createElement('BUTTON');
        button.id = 'btn-' + id;
        button.value = id;
        button.className = 'btn btn-primary m-1 partido-selected';
        button.innerText = cleanedText;
        var iClear = document.createElement('I');
        iClear.className = "bi bi-x";
        button.appendChild(iClear);
        button.onclick = function () {
            var option = document.createElement('OPTION');
            option.id = 'option-' + id;
            option.className = 'sortMe';
            option.value = id;
            option.innerText = text;
            document.getElementById('selectPartido').appendChild(option);
            console.log(document.getElementById('selectPartido').length);
            if (document.getElementById('selectPartido').length == partidosTotal) {
                $('#nonePartidoSpan').show();
            }
            button.remove();
            sortSelectOptions('selectPartido');
            return false;
        };

        sortSelectOptions('selectPartido');
        document.getElementById('partidosContainer').appendChild(button);
    }


    function sortSelectOptions(selectElement) {
        var options = $("#" + selectElement + " option");

        options.sort(function (a, b) {
            if (a.text.toUpperCase() > b.text.toUpperCase()) return 1;
            else if (a.text.toUpperCase() < b.text.toUpperCase()) return -1;
            else return 0;
        });
        $("#" + selectElement).empty().append(options);
    }

    function getSelectedPartidosIds() {
        var buttons = document.getElementsByClassName("partido-selected");
        return Array.from(buttons).map(button => button.value).join("-");
    }

    /*function removeSelectedPartidosFromInput(id) {
        var ids = document.getElementById('selected_partidos_ids').value;
        if (ids.includes(id)) {
            ids = ids.replace(id, "");
        }
        if (ids.includes("--")) {
            ids = ids.replace("--", "-");
        }
        if (ids.endsWith("-")) {
            ids = ids.substring(0, ids.lentgh - 1);
        }
        if (ids.startsWith("-")) {
            ids = ids.substring(1, ids.lentgh);
        }
        document.getElementById('selected_partidos_ids').value = ids;
    }*/
</script>

{% endblock %}