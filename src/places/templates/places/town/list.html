{% extends 'base_system.html' %}

{% block content %}

{% load places_extras %}

<style>
    .cell-centered,
    h5 {
        text-align: center;
    }

    h5 {
        margin-bottom: 10px;
        margin-top: 20px;
    }

    .bool-div {
        color: white;
        padding: 1px;
    }

    .bool-div-true {
        background-color: green;
    }

    .bool-div-false {
        background-color: red;
    }

    td {
        overflow: auto;
        white-space: nowrap;
    }
</style>

<div class="col-md-12 col-xl-10 col-xxl-9 d-flex-inline">
    <div class=" card flex-fill">
        <div class="card-body d-flex flex-column">
            <h2 class="card-title text-center mt-2">LISTADO DE LOCALIDADES</h2>
            <hr class="bg-dark">
            <div
                class="d-grid gap-1 d-lg-flex flex-lg-row gap-md-0 justify-content-lg-start align-items-lg-center text-lg-start">
                <button type="button" id="bulkAsignDeliveryCode" class="btn btn-primary btn-sm m-2 m-xl-0 ms-xl-2"
                    disabled>
                    Asignar código mensajería
                </button>
                <button type="button" id="bulkAsignFlexCode" class="btn btn-primary btn-sm m-2 m-xl-0 ms-xl-2" disabled>
                    Asignar código flex
                </button>
                <div id="selectedCount" class="ms-2 ms-xl-3">0 de {{totalTowns}} elementos seleccionados
                </div>
                <div class="my-1 mx-xl-3">
                    <div id="clearSelectionDiv" class="hide-on-load">
                        <a id="clearSelection" type="button" class="ms-2 text-decoration-none"
                            onclick="removeSelection()" style="cursor: pointer;">Quitar selección
                            <i class="bi bi-x"></i></a>
                    </div>
                </div>
                <div class="d-flex d-lg-inline ms-lg-auto">
                    <a href="{% url 'prices:fcode-add' %}" type="button" class="flex-fill btn btn-success btn-sm m-2">
                        <i class="bi bi-plus"></i>Crear nuevo
                    </a>
                </div>
            </div>
            <hr class="bg-dark">
            <div class="d-inline-flex justify-content-end row mb-3">
                <label for="orderSelection"
                    class="col-4 col-sm-5 col-md-5 col-lg-7 col-xl-8 col-xxl-9 col-form-label form-label text-end">Ordenar
                    por:
                </label>
                <div class="col-8 col-sm-7 col-md-7 col-lg-5 col-xl-4 col-xxl-3" aria-label="Default select example">
                    <select id="orderSelection" class="form-select" aria-label="Default select example">
                        <option value="1" selected>Localidad A-Z</option>
                        <option value="2">Localidad Z-A</option>
                        <option value="3">Partido A-Z</option>
                        <option value="4">Partido Z-A</option>
                        <option value="5">Cód. Mensajería A-Z</option>
                        <option value="6">Cód. Mensajería Z-A</option>
                        <option value="7">Cód. Flex A-Z</option>
                        <option value="8">Cód. Flex Z-A</option>
                    </select>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>
                                <div class="form-check">
                                    <input class="form-check-input checkbox-select" type="checkbox" id="checkAll">
                                </div>
                            </th>
                            <th>Nombre</th>
                            <th>Partido</th>
                            <th>Provincia</th>
                            <th class="cell-centered">Es amba</th>
                            <th class="cell-centered">Zona del amba</th>
                            <th class="cell-centered">Cód. Mensajería</th>
                            <th class="cell-centered">Cód. Flex</th>
                            <th class="cell-centered"></th>
                        </tr>
                    </thead>
                    <tbody id="overrided-1" class="overrided-tbody">
                        {% for item in towns %}
                        {% include 'places/town/snippets/item.html' with obj=item counter=forloop.counter codetype='f' %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
    var selectionModeEnabled = false;
    var totalTowns = JSON.parse('{{ totalTowns | escapejs }}');

    $(document).ready(function () {
        show('clearSelectionDiv', selectionModeEnabled);

        $("#checkAll").click(function () {
            $(".item-checker").prop('checked', this.checked);
            countCheckedItems();
        });

        $(".item-checker").click(function (e) {
            e.stopImmediatePropagation();
            countCheckedItems();
        });

        $(".td-item-checker").click(function (e) {
            var id = this.id.split("-")[1];
            changeItemCheckerState('item-checker-' + id);
            e.stopImmediatePropagation();
            e.stopPropagation();
            countCheckedItems();
        });
    });

    function onItemClicked(id, url) {
        if (selectionModeEnabled) {
            $('#item-checker-' + id).prop('checked', !$('#item-checker-' + id).is(":checked"));
        } else {
            window.location.href = url;
        }
        countCheckedItems();
    }

    function countCheckedItems() {
        // Get all checkboxes
        var checkBoxes = Array.from(document.getElementsByClassName("item-checker"));
        // Count total checkboxes
        var totalCheckBoxes = checkBoxes.length;
        // Count checked checkboxes
        var checkedItemsCount = checkBoxes.filter(checkBox => checkBox.checked == true).length;
        // If all checkboxes checked, check "checkAll" checkbox
        $('#checkAll').prop('checked', checkedItemsCount == totalCheckBoxes);
        // Update selected count
        $('#selectedCount').text(checkedItemsCount + " de " + totalTowns + " elementos seleccionados");
        // Enable bulk edit btn only if more than one checked
        isEnabled('bulkEditDelivery', checkedItemsCount > 1);
        // Enable delete btn if at least 1 checkbox is checked
        isEnabled('bulkDeleteDelivery', checkedItemsCount > 0);
        // Enable selection mode if at least 1 checkbox checked
        selectionModeEnabled = checkedItemsCount > 0;
        // hide
        show('clearSelectionDiv', selectionModeEnabled);
    }

    function changeItemCheckerState(id) {
        $('#' + id).prop('checked', !$('#' + id).is(":checked"));
    }

    function show(id, makeVisible = true) {
        if (makeVisible && $('#' + id).is(":hidden")) {
            $('#' + id).hide();
            $('#' + id).removeClass("hide-on-load");
            $('#' + id).show(300);
        }
        if (!makeVisible && $('#' + id).is(":visible")) {
            $('#' + id).hide(300);
        }
    }

    function isEnabled(id, enable = true) {
        if (enable && $('#' + id).is(":disabled")) {
            $('#' + id).removeAttr("disabled");
        }
        if (!enable && $('#' + id).is(":enabled")) {
            $('#' + id).attr("disabled", true);
        }
    }

    function itemClicked(id) {
        if ($('#item-checker-' + id).is(":checked")) {
            $('#item-checker-' + id).prop('checked', false);
        } else if (selectionModeEnabled) {
            $('#item-checker-' + id).prop('checked', true);
        } else {
            alert("launch detail item");
        }

    }

    function removeSelection() {
        $(".item-checker").prop('checked', false);
        countCheckedItems();
    }

    function deleteSelectedItems() {
        // Get all checked checkboxes
        var checkBoxesIds = Array.from(document.getElementsByClassName("item-checker"))
            .filter(checkBox => checkBox.checked == true).map(function (checkbox) {
                var id = checkbox.id;
                return id.split("-checker-")[1];
            }).join("-");
        console.log(checkBoxesIds);
        var url_mask = "{% url 'prices:fcode-delete' 12345 %}".replace(/12345/, checkBoxesIds);
        console.log("url -> " + url_mask);
        window.location.href = url_mask;
    }
</script>

{% endblock content %}