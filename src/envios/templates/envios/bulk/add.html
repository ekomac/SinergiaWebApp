{% extends 'base_system.html' %}

{% block modal_content %}
{% include 'envios/bulk/snippets/excel-helper-modal.html' %}
{% endblock modal_content %}


{% block content %}

<style>
    td {
        vertical-align: middle;
    }

    .hola {
        background-color: red;
    }

    div .hidden {
        display: none;
    }
</style>
<div class="col-md-12 col-lg-10 col-xl-8 col-xxl-6 d-flex-block">
    <form method='POST' id="create_form" class="card flex-fill shadow-lg bg-white" name="create_form" target="_top"
        enctype="multipart/form-data">{% csrf_token %}

        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                Crear objeto
            </div>
            <div>
                <a href="{{ request.META.HTTP_REFERER }}"><i class="bi bi-arrow-left-short"></i>Volver</a>
            </div>
        </div>

        <div class="card-body">
            <h3 class="card-title text-center mt-3">CARGA MASIVA DE ENVÍOS</h3>

            {% if upload_in_progress %}
            <div class="row mt-3 alert alert-danger mt-3 mb-3" role="alert">
                Existe una carga en curso. Si cargás un nuevo archivo, la carga en curso se cancelará.
            </div>
            {% endif %}

            <div class="row mt-3 mb-4">
                <div class="col-12 col-xl-auto mt-2">
                    <label for="id_file" class="form-label">Archivo con envíos (PDF MercadoLibre o
                        TiendaNube, Excel)</label>
                    <input class="form-control {% if upload_form.file.errors %}is-invalid{% endif %}" type="file"
                        id="id_file" name="file" required>
                    {% comment %} {{ upload_form.file }} {% endcomment %}
                    <div class="invalid-feedback">
                        {% for error in upload_form.file.errors %}
                        {% if error == "File extension 'txt' is not allowed. Allowed extensions are: 'pdf, xlsx'." %}
                        La extensión del archivo proporcionada no está permitida. Las extensiones permitidas son:
                        'pdf, xlsx'.
                        {% else %}
                        {{error}}<br>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="row mt-3 mb-4">
                <div class="col-12 col-lg-6 mt-2">
                    <label for="id_client" class="form-label">Cliente</label>
                    {{upload_form.client}}
                    <div class="invalid-feedback">
                        {% for error in upload_form.client.errors %}{{error}}<br>{% endfor %}
                    </div>
                </div>

                <div class="col-12 col-lg-6 mt-2">
                    <label for="id_deposit" class="form-label">Depósito</label>
                    {{upload_form.deposit}}
                    <div class="invalid-feedback">
                        {% for error in upload_form.client.errors %}{{error}}<br>{% endfor %}
                    </div>
                </div>
            </div>

            <!-- START BUTTONS -->
            <div class="row mt-3">
                <div class="d-grid gap-2 d-md-flex">
                    <button type="submit" class="btn btn-primary"><i class="bi bi-stars">&nbsp;Cargar envíos</i>
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-toggle="modal"
                        data-bs-target="#baseModal">Ayuda
                        sobre el excel</button>
                </div>
            </div>
            <!-- END BUTTONS -->

        </div>
    </form>

</div>

<script>
    var deposits = JSON.parse('{{ deposits | escapejs }}');
    $(document).ready(function () {
        $('#id_deposit').find('option:not(:first)').remove();
        $.event.special.inputchange = {
            setup: function () {
                var self = this,
                    val;
                $.data(this, 'timer', window.setInterval(function () {
                    val = self.value;
                    if ($.data(self, 'cache') != val) {
                        $.data(self, 'cache', val);
                        $(self).trigger('inputchange');
                    }
                }, 20));
            },
            teardown: function () {
                window.clearInterval($.data(this, 'timer'));
            },
            add: function () {
                $.data(this, 'cache', this.value);
            }
        };

        console.log(JSON.stringify(deposits));
        console.log("hello world");
        $('#id_client').on('inputchange', function () {
            var selectedClientId = this.value.toString();
            console.log(selectedClientId);
            if (![null, undefined, ''].includes(selectedClientId)) {
                var depositsFromClient = deposits.filter(function (deposit) {
                    return deposit.client_id == selectedClientId;
                });
                console.log("depositsFromClient", depositsFromClient);
                $('#id_deposit').find('option:not(:first)').remove();
                for (var element of depositsFromClient) {
                    $('#id_deposit').append('<option value="' + element.id + '">' + element.name +
                        '</option>');
                }
            } else {
                $('#id_deposit').find('option:not(:first)').remove();
            }
        });
    });

    function setClientListener() {
        $('#id_client').on('inputchange', function () {
            alert("hola");
            /*
            $('#id_town').find('option:not(:first)').remove();
            for (var element of placesFromPartido) {
                $('#id_town').append('<option value="' + element.id + '">' + element.name +
                    '</option>');
            }
            */
        });
    }
</script>

{% endblock content %}