{% extends 'base_system.html' %} {% block content %} {% load places_extras %}

<style>
    td {
        vertical-align: middle;
    }

    .hola {
        background-color: red;
    }
</style>

<form action='.' method='POST' id="custom_form" class="d-flex row justify-content-md-center needs-validation"
    name="custom_form" target="_top" novalidate>{% csrf_token %}
    <div class="row justify-content-md-center">
        <div class="col">

            <!-- DETAILS IS NOT VISIBLE -->
            <div class="form-group row invisible">
                <div class="col-md-6">
                    {{form.details.errors}}
                    <label for="{{ form.details.id_for_label }}">
                        {{ form.details.label }}<span class="text-danger">*</span>
                    </label> {{ form.detail }}
                    <div class="invalid-feedback">
                        Este campo es obligatorio.
                    </div>
                </div>
            </div>
            <!-- END DETAILS IS NOT VISIBLE -->

            <!-- DETAIL -->

            <div class="form-group row" id="detailDiv">
                <div class="col-lg-8 offset-lg-2">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th style="min-width: 50px;">Cantidad</th>
                                <th style="width: 25px;"></th>
                            </tr>
                        </thead>
                        <tbody>

                            <!-- Max 5 kg package -->
                            <tr class="on-body">
                                <td>Paquete / commerce hasta 5 kg</td>
                                <td>
                                    <input type="number" max="20" min="0" step="1" class="form-control"
                                        id="detailInput0" pattern="^\d+$"></input>
                                    <div class="invalid-feedback">
                                        Obligatorio.
                                    </div>
                                </td>
                                <td>
                                    <div id="clearRowMax5">
                                        <button id="btnClear0" type="button"
                                            class="btn btn-danger clear-amount-button invisible"><i
                                                class="bi bi-x"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <!-- Max 10 kg package -->
                            <tr class="on-body">
                                <td>Bulto hasta 10 kg</td>
                                <td>
                                    <input type="number" max="20" min="0" step="1" class="form-control"
                                        id="detailInput1" pattern="^\d+$"></input>
                                    <div class="invalid-feedback">
                                        Obligatorio.
                                    </div>
                                </td>
                                <td>
                                    <div id="clearRowMax10">
                                        <button id="btnClear1" type="button"
                                            class="btn btn-danger clear-amount-button invisible"><i
                                                class="bi bi-x"></i></button>
                                    </div>
                                </td>
                            </tr>

                            <!-- Max 20 kg package -->
                            <tr class="on-body">
                                <td>Bulto hasta 20 kg</td>
                                <td>
                                    <input type="number" max="20" min="0" step="1" class="form-control"
                                        id="detailInput2" pattern="^\d+$"></input>
                                    <div class="invalid-feedback">
                                        Obligatorio.
                                    </div>
                                </td>
                                <td>
                                    <div id="clearRowMax20">
                                        <button id="btnClear2" type="button"
                                            class="btn btn-danger clear-amount-button invisible"><i
                                                class="bi bi-x"></i></button>
                                    </div>
                                </td>
                            </tr>

                            <!-- Miniflete -->
                            <tr class="on-body">
                                <td>Miniflete</td>
                                <td>
                                    <input type="number" max="20" min="0" step="1" class="form-control"
                                        id="detailInput3" pattern="^\d+$"></input>
                                </td>
                                <td>
                                    <div id="clearRowMiniflete">
                                        <button id="btnClear3" type="button"
                                            class="btn btn-danger clear-amount-button invisible"><i
                                                class="bi bi-x"></i></button>
                                    </div>
                                </td>
                            </tr>

                            <!-- Urgent -->
                            <tr class="on-body">
                                <td>Urgente</td>
                                <td>
                                    <input type="number" max="20" min="0" step="1" class="form-control"
                                        id="detailInput4" pattern="^\d+$"></input>
                                </td>
                                <td>
                                    <div id="clearRowUrgent">
                                        <button id="btnClear4" type="button"
                                            class="btn btn-danger clear-amount-button invisible"><i
                                                class="bi bi-x"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <!-- Tramite -->
                            <tr class="on-body">
                                <td>Trámite</td>
                                <td>
                                    <input type="number" max="20" min="0" step="1" class="form-control"
                                        id="detailInput5" pattern="^\d+$"></input>
                                </td>
                                <td>
                                    <div id="clearRowTramite">
                                        <button id="btnClear5" type="button"
                                            class="btn btn-danger clear-amount-button invisible"><i
                                                class="bi bi-x"></i></button>
                                    </div>
                                </td>
                            </tr>

                        </tbody>
                    </table>
                </div>
            </div>
            <!-- END DETAIL -->

            <div class="form-group row mt-4">
                <h4>Datos del destinatario</h4>
            </div>


            <div class="row mt-2">
                <div class="col">
                    {{ form.client}}
                </div>
            </div>

            <div class="row mt-1">
                <div class="col-5">
                    <label for="{{form.recipent_name.id_for_label}}" class="form-label">Destinatario</label>
                    {{ form.recipent_name}}
                </div>
                <div class="col-3">
                    <label for="{{form.recipent_doc.id_for_label}}" class="form-label">N° de DNI</label>
                    {{ form.recipent_doc}}
                </div>
                <div class="col-4">
                    <label for="{{form.recipent_phone.id_for_label}}" class="form-label">N° de Teléfono</label>
                    {{ form.recipient_phone}}

                </div>
            </div>


            <div class="form-group row mt-4">
                <h4>Datos del envío</h4>
            </div>

            <div class="row mt-1">
                <div class="col-6">
                    <label for="{{form.recipient_address.id_for_label}}" class="form-label">Domicilio</label>
                    {{ form.recipient_address }}
                </div>
                <div class="col-6">
                    <label for="{{form.recipient_entrances.id_for_label}}" class="form-label">Entrecalles
                        (observaciones)</label> {{ form.recipient_entrances}}
                </div>
            </div>


            <div class="row mt-1">
                <div class="col-5">
                    <label for="inputPartido" class="form-label">Partido</label>
                    <select id="inputPartido" class="form-select">
                        <option selected>---------</option>
                        {% for partido in partidos %}
                        <option id="option-{{partido.id}}" value="{{partido.id}}">{{partido.name | title}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-5">
                    <label for="recipient_town" class="form-label">Localidad</label>
                    <select id="recipient_town" class="form-select">
                        <option selected>---------</option>
                    </select>
                </div>
                <div class="col-2">
                    <label for="{{form.recipient_zipcode.id_for_label}}" class="form-label">Cód. postal</label>
                    {{ form.recipient_zipcode}}
                </div>
            </div>

            <div class="row mt-1">
                <div class="col-6">
                    <label for="{{form.max_delivery_date.id_for_label}}" class="form-label">Fecha máxima de
                        entrega</label>
                    {{ form.max_delivery_date}}
                </div>
                <div class="col-6">

                </div>
            </div>

            <div class="row mt-1">
                <div class="col-6">
                    <div class="form-check">
                        <!--<input class="form-check-input" type="checkbox" id="gridCheck">-->
                        {{form.is_flex}}
                        <label for="{{form.is_flex.id_for_label}}" class="form-check-label">
                            ¿Es envío de Flex?
                        </label>
                    </div>
                </div>
                <div class="col-6">
                    <label for="{{form.flex_id.id_for_label}}" class="form-label">Tracking ID Flex</label>
                    {{ form.flex_id}}
                </div>
            </div>

        </div>
    </div>

</form>

<script>
    var places = JSON.parse('{{ places | escapejs }}');
    //var recipientTownId = '#' + JSON.parse('{{ form.recipient_town.id_for_label | escapejs }}').toString();
    //alert(recipient_town);
    const detailInputs = {
        0: "max-5-package",
        1: "max-10-package",
        2: "max-20-package",
        3: "miniflete",
        4: "urgent",
        5: "tramite",
    };

    function isNumeric(value) {
        return /^\d+$/.test(value);
    }

    $(document).ready(function () {


        $('#custom_form').submit(function (event) {
            event.preventDefault(); //this will prevent the default submit
            updateDetails();
            $(this).unbind('submit').submit(); // continue the submit unbind preventDefault
        });
        $.event.special.inputchange = {
            setup: function () {
                var self = this,
                    val;
                $.data(this, 'timer', window.setInterval(function () {
                    val = self.value;
                    if ($.data(self, 'cache') != val) {
                        $.data(self, 'cache', val);
                        $(self).trigger('inputchange');
                    }
                }, 20));
            },
            teardown: function () {
                window.clearInterval($.data(this, 'timer'));
            },
            add: function () {
                $.data(this, 'cache', this.value);
            }
        };

        setPartidoListener();
        setDetailsListeners();
    });

    function setPartidoListener() {
        $('#inputPartido').on('inputchange', function () {
            var selectedPartidoId = this.value.toString();
            var placesFromPartido = places.filter(function (place) {
                return place.partido_id == selectedPartidoId;
            });
            $('#recipient_town').find('option:not(:first)').remove();
            for (var element of placesFromPartido) {
                $('#recipient_town').append('<option id="town-option-' + element.id + '" value="' + element.id +
                    '">' + element.name + '</option>');
            }
            $('#recipient_town').focus();
        });
    }

    function setDetailsListeners() {
        for (let i = 0; i < 6; i++) {
            $('#detailInput' + i).on('inputchange', function () {
                var currentValue = this.value.toString();
                if (currentValue != "" && currentValue != "0" && isNumeric(currentValue)) {
                    $('#btnClear' + i).removeClass("invisible");
                }
                if (currentValue == "" || currentValue == "0" || !isNumeric(currentValue)) {
                    $('#btnClear' + i).addClass("invisible");
                }
            });
            $('#btnClear' + i).on('click', function () {
                $('#detailInput' + i).val("0");
            });
        }
    }

    function updateDetails() {
        try {
            var detailsArray = [];
            for (var i = 0; i < 6; i++) {
                var amount = $("#detailInput" + i).val();
                if (isNumeric(amount) && amount != "0") {
                    detailsArray.push(i.toString() + "-" + amount.toString());
                }
            }
            var details = detailsArray.join(",");
            details = details == "" ? "0-1" : details;
            document.getElementById("id_detail").value = details
        } catch (e) {
            alert(e);
        }
    }

    function myFunction() {
        //alert("hola");
        updateDetails();
    }
</script>


{% endblock %}